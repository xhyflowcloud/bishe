<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="utf-8" />
    <title>iview example</title>

</head>
<body style="background: #f1f1f1">
<div id="rootApp" layout:fragment="content">
    <link href="https://static.360buyimg.com/popd/popd_common/css/pop-design.min.css" type="text/css" rel="stylesheet">
    <script src="https://static.360buyimg.com/popd/js/vue.min.js" type="text/javascript"></script>
    <script src="https://static.360buyimg.com/popd/popd_common/pop-design.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="/js/vue-router-0.7.10.js"></script>
    <script type="text/javascript" src="/js/vue-resource-1.3.4.min.js"></script>
    <script type="text/javascript" src="/js/countdown.js"></script>
    <script type="text/javascript" src="/js/vue.config.js"></script>
    <router-view></router-view>

    <p-card class="form" v-if="registerVisible">
        <p slot="title" style="text-align:center;">
            <span style="color: #e3e8ee;font-size: 20px">注册</span>
        </p>
        <p-form  v-ref:user :rules="ruleInline" label-position="right" >

            <p-form-item rule-key="user" :value="user.name">
                <p-input style="width: 300px" type="text" :value.sync="user.name" placeholder="请输入用户名">
                    <p-icon type="ios-person-outline" slot="prepend"></p-icon>
                </p-input>
            </p-form-item>

            <p-form-item rule-key="email" :value="user.email">
                <p-input style="width: 300px" type="email" :value.sync="user.email" placeholder="请输入邮箱">
                    <p-icon type="ios-email-outline" slot="prepend"></p-icon>
                </p-input>
            </p-form-item>

            <p-form-item rule-key="password" :value="user.pwd">
                <p-input style="width: 300px" type="password" :value.sync="user.pwd" placeholder="请输入用密码">
                    <p-icon type="ios-locked-outline" slot="prepend"></p-icon>
                </p-input>
            </p-form-item>
            <p-form-item rule-key="repassword" :value="repassword">
                <p-input style="width: 300px" type="password" :value.sync="repassword" placeholder="请确认密码">
                    <p-icon type="ios-locked-outline" slot="prepend"></p-icon>

                </p-input>
            </p-form-item>

            <p-form-item>
                <p-button long shape ="circle" type="success" @click="registerSubmit('user')">注册</p-button>
            </p-form-item>
            <p-form-item style="text-align:right;">
                <a href="#"  @click="showLogin">重新登录</a>
            </p-form-item>
        </p-form>
    </p-card>

    <p-card class="form" v-if="loginVisible">
        <p slot="title" style="text-align:center;">
            <span style="color: #e3e8ee;font-size: 20px">登录</span>
        </p>
        <p-form v-ref:user :rules="ruleInline" label-position="right" >

            <p-form-item rule-key="email" :value="user.email">
                <p-input size ="large" style="width: 300px" type="email" :value.sync="user.email" placeholder="请输入邮箱">
                    <p-icon type="ios-email-outline" slot="prepend"></p-icon>
                </p-input>
            </p-form-item>

            <p-form-item rule-key="password" :value="user.pwd">
                <p-input size ="large"  style="width: 300px" type="password" :value.sync="user.pwd" placeholder="请输入密码">
                    <p-icon type="ios-locked-outline" slot="prepend"></p-icon>
                </p-input>
            </p-form-item>

            <p-form-item>
                <p-button long size ="large" shape ="circle" type="success" @click="loginSubmit('user')">登录</p-button>
            </p-form-item>
            <p-form-item style="text-align:right;">
                <a href="#"  @click="showRegister">立即注册</a>
            </p-form-item>
            <!-- 这个user就是v-ref:user的uesr 这个是vue对组件起名字的方式 -->
        </p-form>
    </p-card>

</div>
<script>
    var LoginView = Vue.extend({
        data: function() {
            var validatePass = (rule, value, callback) => {
                if (value === '') {
                    callback(new Error('请再次输入密码'));
                } else if (value !== this.user.pwd) {
                    callback(new Error('两次输入密码不一致!'));
                } else {
                    callback();
                }
            };
            var email = (rule, value, callback) => {
                var mal = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
                if (!value) {
                    return callback(new Error('不能为空'));
                }
                if(!(mal.test(value))) {
                    callback(new Error('请输入正确邮箱'));
                }else{
                    callback();
                }
            };
            return {
                ruleInline: {
                    user: [{
                        required: true,
                        message: '请填写用户名',
                    }],
                    password: [{
                        required: true,
                        message: '请填写密码',
                        trigger: 'blur',
                    }, {
                        type: 'string',
                        min: 6,
                        message: '密码长度不能小于6位',
                        trigger: 'blur',
                    }],
                    repassword:[{
                        required: true,
                        message: '请填写确认密码',
                        trigger: 'blur',
                    }, {
                        validator: validatePass,
                        trigger: 'blur',
                    }],
                    email:[{
                        required: true,
                        message: '请填写邮箱',
                        trigger: 'blur',
                    },{
                        validator: email,
                        triger: 'blur',
                    }]
                },
                user: {
                    name: '',
                    pwd: '',
                    email: '',
                },
                repassword: '',
                theme: 'dark',
                loginVisible: true,
                registerVisible:false,
            }
        },
        methods: {
            registerSubmit: function(name) {
                this.$refs[name].validate(function(valid) {
                    if (valid) {
                        this.$http.post('/index/register', this.user).then(function (res) {
                            if(res.body.trim() == '注册成功'){
                                this.$Message.success(res.body);
                            }
                            else{
                                this.$Message.error(res.body + '!');
                            }
                        });
                    } else {
                        this.$Message.error('表单验证失败!');
                    }
                }.bind(this));
                //bind 是改变一个函数的this指向；这儿就是把function(valid)内部的this指向改成外面vue 的this（this劫持）
            },
            loginSubmit: function(name) {
                this.$refs[name].validate(function(valid) {
                    if (valid) {
                        this.$http.post('/index/login', this.user).then(function (res) {
                            if(res.body.trim() == '登录成功'){
                                this.$Message.success(res.body);
                            }
                            else{
                                this.$Message.error(res.body + '!');
                            }
                        });
                    } else {
                        this.$Message.error('表单验证失败!');
                    }
                }.bind(this));
                //bind 是改变一个函数的this指向；这儿就是把function(valid)内部的this指向改成外面vue 的this（this劫持）
            },
            showLogin: function(){
                this.loginVisible = true;
                this.registerVisible=false;
            },
            showRegister: function () {
                this.loginVisible = false;
                this.registerVisible=true;
            }
        }
    })

    var router = new VueRouter();

    router.map({
        '/': {name: 'main', component: LoginView},
    });

    router.start(LoginView, '#rootApp');

</script>
<link href="/css/app.css" rel="stylesheet" type="text/css"/>
</body>
</html>
